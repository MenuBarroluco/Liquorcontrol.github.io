<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Bar Control Palmas</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- 5. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* DARK THEME GLOBAL */
        body { background-color: #020617; color: #f8fafc; font-family: sans-serif; }
        .animate-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Scanner */
        #reader { border: none !important; }
        #reader video { border-radius: 12px; object-fit: cover; width: 100% !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        window.fb = { initializeApp, getFirestore, doc, setDoc, onSnapshot, getDoc, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Component } = React;

        // ==========================================
        // ðŸ”‘ CONFIGURACIÃ“N FIREBASE
        // ==========================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBbyENQwbbPzbwpxd9WIVIkaZP1zYkn8X4",
            authDomain: "liquor-control.firebaseapp.com",
            projectId: "liquor-control",
            storageBucket: "liquor-control.firebasestorage.app",
            messagingSenderId: "221278168324",
            appId: "1:221278168324:web:b763c0bc4c1020d40d1c51"
        };

        // ==========================================
        // ðŸ“‹ PAR LEVELS (NIVELES IDEALES)
        // ==========================================
        const PAR_LEVELS = {
            // Liquor
            "Crown Royal Regal": 2, 
            "Apple Crown Royal": 2,
            "Jack Daniels Black": 4,
            "Jameson": 2,
            "WoodFord Reserve": 1,
            "Buchanans 12": 6,
            "Johnnie Walker Black": 4,
            "Grand Old Parr 12": 2,
            "Hennessy VS": 3,
            "Tito's Texas Vodka": 3,
            "Remy Martin": 1,
            "Grey Goose": 3,
            "Casamigos Blanco": 4,
            "Casamigos Reposado": 2,
            "Espolon Blanco": 2,
            "Espolon Reposado": 1,
            "Don Julio Blanco": 6,
            "Don Julio Reposado": 2,
            "Patron Silver": 6,
            "Patron Reposado": 1,
            "Fernet Branca": 2,
            "Brugal Anejo": 1,
            "Montezuma White": 12,
            "Barton Naturals Vodka": 12,
            "Long Island Tea Mix": 6,
            "Peach Schnapps Boston": 12,
            "Triple Sec Boston": 12,
            "Bacardi Light": 6,
            
            // Beers
            "Modelo Especial": 600,
            "Corona": 720,
            "Michelob Ultra": 96,
            "Heineken": 48,
            "Pacifico": 72,

            // Energy & Seltzer
            "Red Bull Regular": 96,
            "Red Bull Sugar Free": 96,
            "Red Bull Watermelon": 72,

            // Wines
            "Cafayate Malbec": 6 
        };

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) return <div className="p-10 text-center text-red-400">Application Error. Reload Page. <br/> {this.state.error?.toString()}</div>;
                return this.props.children;
            }
        }

        // --- ICONS ---
        const IconWrapper = ({ children, className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Beer: (p) => <IconWrapper {...p}><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M9 12h6"/><path d="M9 12v3a8 8 0 0 1-16 0v-3"/><path d="M22 6h-7a2 2 0 0 0-2 2v2"/><path d="M5 12V3a2 2 0 0 1 2-2h7"/></IconWrapper>,
            Wine: (p) => <IconWrapper {...p}><path d="M8 22h8"/><path d="M7 10h10"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/></IconWrapper>,
            GlassWater: (p) => <IconWrapper {...p}><path d="M15.2 22H8.8a2 2 0 0 1-2-1.79L5 3h14l-1.81 17.21A2 2 0 0 1 15.2 22Z"/><path d="M6 12a5 5 0 0 1 6 0 5 5 0 0 0 6 0"/></IconWrapper>,
            Package: (p) => <IconWrapper {...p}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Search: (p) => <IconWrapper {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
            Download: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>,
            ChevronDown: (p) => <IconWrapper {...p}><path d="m6 9 6 6 6-6"/></IconWrapper>,
            ChevronUp: (p) => <IconWrapper {...p}><path d="m18 15-6-6-6 6"/></IconWrapper>,
            AlertTriangle: (p) => <IconWrapper {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconWrapper>,
            CheckCircle: (p) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></IconWrapper>,
            RotateCcw: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>,
            Calculator: (p) => <IconWrapper {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>,
            MapPin: (p) => <IconWrapper {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            DollarSign: (p) => <IconWrapper {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconWrapper>,
            ShoppingCart: (p) => <IconWrapper {...p}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconWrapper>,
            RefreshCw: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>,
            Box: (p) => <IconWrapper {...p}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            ArrowRight: (p) => <IconWrapper {...p}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconWrapper>,
            Trash: (p) => <IconWrapper {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></IconWrapper>,
            BarChart: (p) => <IconWrapper {...p}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></IconWrapper>,
            Cloud: (p) => <IconWrapper {...p}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19c3.037 0 5.5-2.463 5.5-5.5S20.537 8 17.5 8"/><path d="M17.5 8c0-3.037-2.463-5.5-5.5-5.5S6.5 4.963 6.5 8"/><path d="M6.5 19C3.463 19 1 16.537 1 13.5S3.463 8 6.5 8"/></IconWrapper>,
            HardDrive: (p) => <IconWrapper {...p}><line x1="22" x2="22" y1="12" y2="12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" x2="6.01" y1="16" y2="16"/><line x1="10" x2="10.01" y1="16" y2="16"/></IconWrapper>,
            Save: (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            Upload: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconWrapper>,
            Scan: (p) => <IconWrapper {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect width="10" height="6" x="7" y="9" rx="1"/></IconWrapper>,
            Barcode: (p) => <IconWrapper {...p}><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></IconWrapper>,
            ErrorIcon: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>
        };

        // --- AUDIO HELPER ---
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                const now = ctx.currentTime;

                switch (type) {
                    case 'success':
                        osc.type = "sine";
                        osc.frequency.setValueAtTime(1200, now);
                        osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        osc.start(now);
                        osc.stop(now + 0.15);
                        break;
                    case 'add':
                        osc.type = "sine";
                        osc.frequency.setValueAtTime(800, now);
                        osc.frequency.linearRampToValueAtTime(1000, now + 0.1);
                        gain.gain.setValueAtTime(0.08, now);
                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        osc.start(now);
                        osc.stop(now + 0.15);
                        break;
                    case 'sub':
                        osc.type = "triangle";
                        osc.frequency.setValueAtTime(400, now);
                        osc.frequency.linearRampToValueAtTime(300, now + 0.1);
                        gain.gain.setValueAtTime(0.08, now);
                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        osc.start(now);
                        osc.stop(now + 0.15);
                        break;
                }
            } catch (e) { console.error("Audio play failed", e); }
        };

        // --- COMPONENTS ---
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message, isDestructive }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-in">
                    <div className="bg-gray-900 border border-gray-700 rounded-xl max-w-md w-full p-6 shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-2 flex items-center gap-2">
                            {isDestructive ? <Icons.AlertTriangle className="text-red-500" /> : <Icons.CheckCircle className="text-indigo-500" />}
                            {title}
                        </h3>
                        <p className="text-gray-300 mb-6 whitespace-pre-line leading-relaxed">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 rounded-lg bg-gray-800 text-gray-300 hover:bg-gray-700 transition-colors border border-gray-700 font-medium">Cancel</button>
                            <button onClick={onConfirm} className={`px-4 py-2 rounded-lg text-white font-bold transition-colors shadow-lg ${isDestructive ? 'bg-red-600 hover:bg-red-500 shadow-red-900/20' : 'bg-indigo-600 hover:bg-indigo-500 shadow-indigo-900/20'}`}>Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        const QuickEditModal = ({ item, onClose, onUpdate }) => {
            if (!item) return null;
            const [activeField, setActiveField] = useState('bodega');
            const currentValue = parseFloat(item[activeField]) || 0;

            const handleDelta = (delta) => {
                if (delta > 0) playSound('add'); else playSound('sub');
                const next = Math.round((currentValue + delta) * 10) / 10;
                const newValue = Math.max(0, next);
                onUpdate(item.id, activeField, newValue);
            };

            const locations = [
                { id: 'bodega', label: 'Storage (Bodega)' },
                { id: 'bar1', label: 'Bar 1' },
                { id: 'bar2', label: 'Bar 2' },
                { id: 'barroluco', label: 'Barroluco' },
                { id: 'purchases', label: 'Purchases (Compras)' }
            ];

            return (
                <div className="fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-[60] backdrop-blur-md animate-in p-4">
                    <div className="bg-slate-900 border border-slate-700 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                            <div><h2 className="text-xl font-bold text-white leading-tight">{item.name}</h2><p className="text-xs text-slate-400 font-mono mt-1">Quick Edit Mode</p></div>
                            <button onClick={onClose} className="bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-full transition-colors"><span className="text-xl px-2">&times;</span></button>
                        </div>
                        <div className="p-2 bg-slate-900 border-b border-slate-800 overflow-x-auto">
                            <div className="flex gap-2">
                                {locations.map(loc => (
                                    <button key={loc.id} onClick={() => setActiveField(loc.id)} className={`px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all ${activeField === loc.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{loc.label}</button>
                                ))}
                            </div>
                        </div>
                        <div className="flex-1 p-6 flex flex-col items-center justify-center bg-gradient-to-b from-slate-900 to-slate-950 overflow-y-auto">
                            <div className="text-center mb-8">
                                <div className="text-slate-400 text-sm uppercase font-bold tracking-wider mb-2">Current Count ({locations.find(l => l.id === activeField)?.label})</div>
                                <div className="text-7xl font-black text-white font-mono tracking-tight tabular-nums">{currentValue}</div>
                            </div>
                            <div className="w-full grid grid-cols-2 gap-6">
                                <div className="flex flex-col gap-2 items-end">
                                    <button onClick={() => handleDelta(-24)} className="w-full bg-red-900/20 hover:bg-red-900/40 text-red-500 border border-red-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">- 24</button>
                                    <button onClick={() => handleDelta(-12)} className="w-full bg-red-900/20 hover:bg-red-900/40 text-red-500 border border-red-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">- 12</button>
                                    <button onClick={() => handleDelta(-6)} className="w-full bg-red-900/20 hover:bg-red-900/40 text-red-500 border border-red-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">- 6</button>
                                    <button onClick={() => handleDelta(-1)} className="w-full bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-900/40 py-3 rounded-xl font-black text-xl active:scale-95 transition-all">- 1</button>
                                    <button onClick={() => handleDelta(-0.1)} className="w-full bg-slate-800 hover:bg-slate-700 text-red-400 border border-slate-700 py-3 rounded-xl font-bold text-lg active:scale-95 transition-all">- 0.1</button>
                                </div>
                                <div className="flex flex-col gap-2 items-start">
                                    <button onClick={() => handleDelta(24)} className="w-full bg-emerald-900/20 hover:bg-emerald-900/40 text-emerald-500 border border-emerald-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">+ 24</button>
                                    <button onClick={() => handleDelta(12)} className="w-full bg-emerald-900/20 hover:bg-emerald-900/40 text-emerald-500 border border-emerald-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">+ 12</button>
                                    <button onClick={() => handleDelta(6)} className="w-full bg-emerald-900/20 hover:bg-emerald-900/40 text-emerald-500 border border-emerald-900/50 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all">+ 6</button>
                                    <button onClick={() => handleDelta(1)} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/40 py-3 rounded-xl font-black text-xl active:scale-95 transition-all">+ 1</button>
                                    <button onClick={() => handleDelta(0.1)} className="w-full bg-slate-800 hover:bg-slate-700 text-emerald-400 border border-slate-700 py-3 rounded-xl font-bold text-lg active:scale-95 transition-all">+ 0.1</button>
                                </div>
                            </div>
                        </div>
                        <div className="p-4 bg-slate-900 border-t border-slate-800"><button onClick={onClose} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-900/30">Done</button></div>
                    </div>
                </div>
            );
        };

        const ShoppingListModal = ({ isOpen, onClose, items }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/90 flex flex-col z-50 backdrop-blur-sm animate-in overflow-hidden">
                    <div className="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2"><Icons.ShoppingCart className="text-amber-500" /> Shopping List</h2>
                        <button onClick={onClose} className="p-2 bg-gray-800 text-gray-300 rounded-lg hover:bg-gray-700">Close</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4">
                        {items.length === 0 ? (
                            <div className="text-center text-gray-500 mt-20"><p className="text-lg">All items are fully stocked!</p></div>
                        ) : (
                            <div className="grid gap-3">
                                {items.map((item, idx) => (
                                    <div key={idx} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center shadow-lg">
                                        <div>
                                            <h3 className="font-bold text-white text-lg">{item.name}</h3>
                                            <div className="text-xs text-gray-400 font-mono mt-1">On Hand: <span className="text-emerald-400">{item.current}</span> / Target: <span className="text-blue-400">{item.target}</span></div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-[10px] text-amber-500 uppercase font-bold">To Buy</div>
                                            <div className="text-2xl font-black text-amber-400">{item.needed}</div>
                                            {item.details && <div className="text-[10px] text-slate-500 font-mono mt-1">{item.details}</div>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="p-4 bg-gray-900 border-t border-gray-800"><p className="text-center text-xs text-gray-500">Auto-Round: â‰¤0.5 Down, >0.5 Up</p></div>
                </div>
            );
        };

        const ScannerModal = ({ onScanSuccess, onClose }) => {
            const [scanError, setScanError] = useState(null);
            const scannerRef = useRef(null);

            useEffect(() => {
                if (!window.Html5QrcodeScanner) { setScanError("Lib not loaded"); return; }
                const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
                if (!isSecure) { setScanError("Camera requires HTTPS."); return; }
                if (!scannerRef.current) {
                    try {
                        const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 }, false);
                        scannerRef.current = scanner;
                        scanner.render((decodedText) => { scanner.clear().then(() => onScanSuccess(decodedText)).catch(console.error); }, (error) => {});
                    } catch(err) { console.error(err); setScanError("Camera error."); }
                }
                return () => { if (scannerRef.current) scannerRef.current.clear().catch(console.error); };
            }, []);

            return (
                <div className="fixed inset-0 bg-black/95 flex flex-col z-50 animate-in">
                    <div className="p-4 flex justify-between items-center bg-gray-900 border-b border-gray-800">
                        <h3 className="text-white font-bold flex items-center gap-2"><Icons.Scan className="text-amber-500" /> Scan Barcode</h3>
                        <button onClick={onClose} className="text-gray-400 hover:text-white px-3 py-1 rounded bg-gray-800">Close</button>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center p-4 relative">
                        {scanError ? <div className="bg-red-900/50 border border-red-500 p-6 rounded-xl text-center max-w-sm text-red-200">{scanError}</div> : <div id="reader" className="w-full max-w-sm bg-black rounded-xl overflow-hidden border-2 border-indigo-500/50 shadow-2xl"></div>}
                    </div>
                </div>
            );
        };

        const ChartsView = ({ data, onClose }) => {
            const canvasRef = useRef(null);
            const chartInstance = useRef(null);

            const { activeItems, totals, categoryData } = useMemo(() => {
                let items = [];
                let totalConsumed = 0; let totalSold = 0; let totalDiff = 0;
                let catMap = {};

                data.forEach(cat => {
                    let catSales = 0;
                    cat.items.forEach(item => {
                        const totalPhys = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
                        const totalStart = (parseFloat(item.start_bar1)||0) + (parseFloat(item.start_bar2)||0) + (parseFloat(item.start_bodega)||0) + (parseFloat(item.start_barroluco)||0);
                        const purchases = parseFloat(item.purchases)||0;
                        const sales = parseFloat(item.sales)||0;
                        const systemConsumption = totalStart + purchases - totalPhys;
                        const diff = sales - systemConsumption;
                        if (systemConsumption > 0 || sales > 0) {
                            items.push({ ...item, systemConsumption, sales, diff });
                            totalConsumed += systemConsumption; totalSold += sales; totalDiff += diff;
                            catSales += sales;
                        }
                    });
                    if (catSales > 0) catMap[cat.category] = catSales;
                });
                return { activeItems: items.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff)), totals: { totalConsumed, totalSold, totalDiff }, categoryData: catMap };
            }, [data]);

            useEffect(() => {
                if (canvasRef.current && window.Chart) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    const labels = Object.keys(categoryData);
                    const values = Object.values(categoryData);
                    const colors = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#06b6d4', '#ef4444'];
                    chartInstance.current = new window.Chart(ctx, {
                        type: 'doughnut',
                        data: { labels: labels, datasets: [{ data: values, backgroundColor: colors, borderColor: '#0f172a', borderWidth: 2, hoverOffset: 4 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 11, family: 'monospace' }, boxWidth: 12 } }, title: { display: false } }, layout: { padding: 10 } }
                    });
                }
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [categoryData]);

            return (
                <div className="fixed inset-0 bg-[#0B1120] flex flex-col z-50 animate-in overflow-hidden">
                    <div className="p-4 border-b border-slate-800/60 flex justify-between items-center bg-slate-900/50 backdrop-blur-md">
                        <h2 className="text-xl font-bold text-white flex items-center gap-3"><div className="p-2 bg-indigo-500/10 rounded-xl border border-indigo-500/20"><Icons.BarChart className="text-indigo-400" size={20} /></div>Performance Analytics</h2>
                        <button onClick={onClose} className="px-4 py-2 bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700 hover:text-white transition-colors text-sm font-medium border border-slate-700">Close</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="space-y-3 flex flex-col">
                                <div className="flex-1 bg-slate-800/40 p-5 rounded-2xl border border-slate-700/50 shadow-lg flex flex-col justify-center">
                                    <div className="text-[11px] text-slate-400 uppercase font-bold tracking-wider mb-2 flex items-center gap-2"><Icons.Package size={14} className="text-slate-500"/> Total Consumed</div>
                                    <div className="text-4xl font-black text-slate-200">{totals.totalConsumed.toFixed(1)}</div>
                                </div>
                                <div className="flex-1 bg-slate-800/40 p-5 rounded-2xl border border-slate-700/50 shadow-lg flex flex-col justify-center">
                                    <div className="text-[11px] text-indigo-300 uppercase font-bold tracking-wider mb-2 flex items-center gap-2"><Icons.DollarSign size={14} className="text-indigo-500"/> Total Sales (POS)</div>
                                    <div className="text-4xl font-black text-indigo-400">{totals.totalSold.toFixed(1)}</div>
                                </div>
                                <div className={`flex-1 bg-slate-800/40 p-5 rounded-2xl border shadow-lg flex flex-col justify-center ${totals.totalDiff < 0 ? 'border-red-500/30 bg-red-900/5' : 'border-emerald-500/30 bg-emerald-900/5'}`}>
                                    <div className={`text-[11px] uppercase font-bold tracking-wider mb-2 flex items-center gap-2 ${totals.totalDiff < 0 ? 'text-red-400' : 'text-emerald-400'}`}><Icons.RotateCcw size={14}/> Net Difference</div>
                                    <div className={`text-4xl font-black ${totals.totalDiff < 0 ? 'text-red-400' : 'text-emerald-400'}`}>{totals.totalDiff > 0 ? '+' : ''}{totals.totalDiff.toFixed(1)}</div>
                                </div>
                            </div>
                            <div className="bg-slate-800/40 p-2 rounded-2xl border border-slate-700/50 shadow-lg min-h-[250px] relative flex flex-col">
                                <div className="absolute top-4 left-4 text-xs font-bold text-slate-400 uppercase tracking-widest z-10">Sales Share</div>
                                <div className="flex-1 relative mt-4"><canvas ref={canvasRef}></canvas></div>
                                {Object.keys(categoryData).length === 0 && <div className="absolute inset-0 flex items-center justify-center text-slate-500 text-sm">No sales data yet</div>}
                            </div>
                        </div>
                        <div className="space-y-3">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest px-1 mt-6">Detailed Breakdown</h3>
                            {activeItems.length === 0 && <div className="text-center py-20 flex flex-col items-center opacity-50"><div className="p-6 rounded-full bg-slate-800/50 mb-4 border border-slate-700"><Icons.BarChart className="text-slate-500" size={40} /></div><p className="text-slate-400 font-medium">No active data found for this period.</p></div>}
                            {activeItems.map(item => {
                                const maxValue = Math.max(item.systemConsumption, item.sales, 1); 
                                const consumePercent = (item.systemConsumption / maxValue) * 100;
                                const salesPercent = (item.sales / maxValue) * 100;
                                const isLoss = item.diff < -0.1; const isGain = item.diff > 0.1;
                                return (
                                    <div key={item.id} className="bg-slate-900/80 border border-slate-800 p-5 rounded-2xl relative overflow-hidden group hover:border-slate-700 transition-all shadow-md">
                                        {isLoss && <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-red-600 to-red-400"></div>}
                                        {isGain && <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-emerald-600 to-emerald-400"></div>}
                                        <div className="flex justify-between items-start mb-5 pl-2 relative z-10">
                                            <div>
                                                <div className="font-bold text-slate-100 text-lg leading-tight tracking-tight">{item.name}</div>
                                                <div className="text-[10px] text-slate-500 font-mono mt-1 flex items-center gap-2">ID: {item.id} {isLoss && <span className="text-red-500 font-bold bg-red-900/20 px-1.5 rounded text-[9px] border border-red-900/50">LOSS</span>}</div>
                                            </div>
                                            <div className={`px-3 py-1.5 rounded-lg text-sm font-black font-mono border min-w-[60px] text-center shadow-sm ${isLoss ? 'bg-red-500/10 text-red-400 border-red-500/20' : isGain ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-slate-800 text-slate-400 border-slate-700'}`}>{item.diff > 0 ? '+' : ''}{item.diff.toFixed(2)}</div>
                                        </div>
                                        <div className="space-y-4 pl-2 relative z-10">
                                            <div className="relative">
                                                <div className="flex justify-between text-[11px] mb-1.5"><span className="text-slate-500 font-bold uppercase tracking-wider">Inventory Used</span><span className="text-slate-300 font-mono font-bold">{item.systemConsumption.toFixed(1)}</span></div>
                                                <div className="h-2.5 w-full bg-slate-800 rounded-full overflow-hidden border border-slate-700/50"><div className="h-full bg-slate-500 rounded-full opacity-50" style={{ width: `${consumePercent}%`, transition: 'width 1s ease-out' }}></div></div>
                                            </div>
                                            <div className="relative">
                                                <div className="flex justify-between text-[11px] mb-1.5"><span className={`${isLoss ? 'text-red-400' : 'text-indigo-400'} font-bold uppercase tracking-wider`}>POS Sales</span><span className={`${isLoss ? 'text-red-300' : 'text-indigo-300'} font-mono font-bold`}>{item.sales.toFixed(1)}</span></div>
                                                <div className="h-2.5 w-full bg-slate-800 rounded-full overflow-hidden border border-slate-700/50"><div className={`h-full rounded-full shadow-[0_0_12px_rgba(0,0,0,0.5)] ${isLoss ? 'bg-gradient-to-r from-red-600 to-red-400 shadow-red-500/20' : 'bg-gradient-to-r from-indigo-600 to-indigo-400 shadow-indigo-500/20'}`} style={{ width: `${salesPercent}%`, transition: 'width 1s ease-out' }}></div></div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const Header = ({ onNewPeriod, onClearAll, onDownload, onShowCharts, onBackup, onRestore, isCloud, onScan, onShopping, logoSrc, onLogoUpload }) => {
            const date = new Date();
            // CAMBIO 1: Fecha en InglÃ©s (en-US)
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            let dateStr = date.toLocaleDateString('en-US', options);
            // Capitalizar primera letra (aunque en inglÃ©s ya suele venir bien, esto asegura consistencia)
            dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

            return (
                <header className="bg-slate-900 border-b border-slate-800 text-white p-4 shadow-xl">
                    <div className="max-w-6xl mx-auto flex flex-col lg:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-3 w-full lg:w-auto">
                            <div className="bg-slate-800 p-1 rounded-full border border-slate-700 shadow-lg overflow-hidden h-14 w-14 flex-shrink-0 cursor-pointer hover:border-indigo-500 transition-all relative group" onClick={() => document.getElementById('logo-upload').click()} title="Click to change logo">
                                <img src={logoSrc} alt="Logo" className="h-full w-full object-cover rounded-full" onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/100x100/4f46e5/ffffff?text=LOGO"; }} />
                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-full"><Icons.Upload size={16} className="text-white" /></div>
                            </div>
                            <input type="file" id="logo-upload" accept="image/*" className="hidden" onChange={onLogoUpload} />
                            <div>
                                <h1 className="font-bold text-lg leading-tight text-white">Master Bar Control Palmas</h1>
                                <div className="flex items-center gap-2 text-xs">
                                    <span className="text-slate-400">Sales Analysis</span>
                                    <span className={`px-2 py-0.5 rounded-full border ${isCloud ? 'bg-indigo-900/50 border-indigo-500 text-indigo-200' : 'bg-slate-800 border-slate-600 text-slate-400'} flex items-center gap-1 transition-colors`}>{isCloud ? <Icons.Cloud size={10} /> : <Icons.HardDrive size={10} />}{isCloud ? 'Cloud' : 'Local'}</span>
                                </div>
                            </div>
                        </div>
                        <div className="flex flex-col lg:items-end gap-2 w-full lg:w-auto">
                            <div className="text-indigo-300 font-bold uppercase text-xs tracking-widest mb-2 lg:mb-0 lg:mr-1 text-center lg:text-right">{dateStr}</div>
                            <div className="flex flex-wrap justify-center lg:justify-end gap-2 w-full lg:w-auto items-center">
                                <button onClick={onScan} className="flex items-center gap-3 bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-xl font-bold border border-slate-600 text-lg shadow-lg hover:shadow-xl hover:border-indigo-500 transition-all active:scale-95 mr-2"><Icons.Scan size={24} className="text-indigo-400" /> SCAN</button>
                                {!isCloud && (
                                    <div className="flex gap-2 mr-2 pr-2 border-r border-slate-700">
                                        <button onClick={onBackup} className="flex items-center gap-1 bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-2 rounded-lg text-sm border border-slate-700 transition-all"><Icons.Save size={16} /></button>
                                        <button onClick={onRestore} className="flex items-center gap-1 bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-2 rounded-lg text-sm border border-slate-700 transition-all"><Icons.Upload size={16} /></button>
                                    </div>
                                )}
                                <button onClick={onShowCharts} className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded-lg font-medium border border-slate-700 text-sm shadow-sm"><Icons.BarChart size={18} className="text-indigo-400" /></button>
                                <button onClick={onNewPeriod} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-medium shadow-lg shadow-indigo-900/20 active:scale-95 text-sm border border-indigo-500"><Icons.ArrowRight size={18} /> Next</button>
                                <button onClick={onShopping} className="flex items-center gap-2 bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded-lg font-medium shadow-lg shadow-amber-900/20 active:scale-95 text-sm border border-amber-500"><Icons.ShoppingCart size={18} /> Shopping</button>
                                <button onClick={onDownload} className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-medium shadow-lg shadow-emerald-900/20 active:scale-95 text-sm border border-emerald-500"><Icons.Download size={18} /> CSV</button>
                                <button onClick={onClearAll} className="p-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg border border-red-200 transition-colors"><Icons.Trash size={20}/></button>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };

        const CategoryHeader = ({ title, icon: Icon, isOpen, toggle }) => (
            <button onClick={toggle} className="w-full flex items-center justify-between p-4 bg-slate-800 border border-slate-700 hover:bg-slate-700 rounded-xl shadow-lg mb-2 transition-all group">
                <div className="flex items-center gap-3">
                    <div className="text-indigo-400 group-hover:text-indigo-300 transition-colors"><Icon size={20} /></div>
                    <h2 className="font-bold text-slate-200 text-lg group-hover:text-white transition-colors">{title}</h2>
                </div>
                {isOpen ? <Icons.ChevronUp className="text-slate-500" /> : <Icons.ChevronDown className="text-slate-500" />}
            </button>
        );

        const InputField = ({ label, value, onChange, colorClass = "border-slate-700", icon: Icon }) => (
            <div className="relative group">
                <label className="block text-[10px] text-slate-400 font-bold uppercase mb-1 flex items-center gap-1 group-hover:text-indigo-400 transition-colors">{Icon && <Icon size={10} />} {label}</label>
                <input type="number" step="0.1" placeholder="-" value={value} onChange={(e) => onChange(e.target.value)} className={`w-full bg-slate-900 border rounded-lg px-3 py-2 font-mono text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500/50 focus:border-indigo-500 transition-all ${colorClass} ${value !== "" && value !== 0 ? 'text-indigo-300 font-bold border-indigo-500/50 bg-indigo-900/20' : 'text-slate-500'}`} />
            </div>
        );

        const InventoryRow = ({ item, onUpdate, onLinkBarcode, pendingBarcode, isWells, categoryName, onScanRequest }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const isUnitBased = categoryName.includes("Beers") || categoryName.includes("Seltzer");
            const totalPhys = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
            const totalStart = (parseFloat(item.start_bar1)||0) + (parseFloat(item.start_bar2)||0) + (parseFloat(item.start_bodega)||0) + (parseFloat(item.start_barroluco)||0);
            const purchases = parseFloat(item.purchases) || 0;
            const sales = parseFloat(item.sales) || 0;
            const systemConsumption = totalStart + purchases - totalPhys;
            const diff = sales - systemConsumption;
            const hasPhysical = item.bar1 || item.bar2 || item.bodega || item.barroluco;
            const hasStart = item.start_bar1 || item.start_bar2 || item.start_bodega || item.start_barroluco;
            const hasBarcode = !!item.barcode;
            const hasCaseBarcode = !!item.barcode_case; // NUEVO CAMPO DE CASE

            const bottleSizeOz = isWells ? 33.814 : 25.36;
            const shotsPerBottle = bottleSizeOz / 1.2; 

            const handleSalesChange = (type, val) => {
                let newBottles = type === 'bottles' ? val : (item.sold_bottles || "");
                let newShots = type === 'shots' ? val : (item.sold_shots || "");
                let newComps = type === 'comps' ? val : (item.sold_comps || "");
                const b = parseFloat(newBottles) || 0; const s = parseFloat(newShots) || 0; const c = parseFloat(newComps) || 0;
                let totalSales = 0;
                if (isUnitBased) totalSales = b + (s * 6) + c;
                else totalSales = b + ((s * 1.2) / bottleSizeOz) + c;
                onUpdate(item.id, { sold_bottles: newBottles, sold_shots: newShots, sold_comps: newComps, sales: totalSales > 0 ? totalSales.toFixed(2) : "" });
            };
            
            const handleDirectSalesUpdate = (val) => { onUpdate(item.id, 'sales', val); };

            let statusColor = "bg-slate-800 border-slate-700"; let badgeClass = "text-slate-400 bg-slate-900 border border-slate-700";
            if (hasPhysical && hasStart) {
                if (diff < -0.1) { statusColor = "bg-slate-800 border-red-500/50 shadow-[inset_4px_0_0_0_#ef4444]"; badgeClass = "text-red-400 bg-red-900/20 border border-red-500/30"; }
                else if (diff > 0.1) { statusColor = "bg-slate-800 border-blue-500/50 shadow-[inset_4px_0_0_0_#3b82f6]"; badgeClass = "text-blue-400 bg-blue-900/20 border border-blue-500/30"; }
                else { statusColor = "bg-slate-800 border-emerald-500/50 shadow-[inset_4px_0_0_0_#10b981]"; badgeClass = "text-emerald-400 bg-emerald-900/20 border border-emerald-500/30"; }
            }

            return (
                <div className={`rounded-xl border shadow-lg transition-all duration-300 overflow-hidden ${statusColor} mb-3 relative z-10`}>
                    <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-slate-700/30 transition-colors" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex-1">
                            <div className="flex items-center gap-2">
                                <span className="font-bold text-slate-200 text-base">{item.name}</span>
                                {hasBarcode && <Icons.Barcode size={14} className="text-indigo-400" />}
                                {hasCaseBarcode && <Icons.Box size={14} className="text-amber-400" />} {/* INDICADOR DE CASE */}
                                {(hasPhysical && hasStart) ? <span className={`text-xs font-mono font-bold px-2 py-0.5 rounded-md ${badgeClass}`}>{diff > 0 ? "+" : ""}{diff.toFixed(1)}</span> : null}
                            </div>
                            <div className="text-xs text-slate-500 mt-1 flex gap-3 font-mono">
                                <span>On Hand: <b className="text-slate-300">{totalStart}</b></span><span className="text-slate-600">|</span><span>Physical: <b className="text-slate-300">{totalPhys}</b></span>
                            </div>
                        </div>
                        <div>{isExpanded ? <Icons.ChevronUp className="text-slate-500" /> : <Icons.ChevronDown className="text-slate-500" />}</div>
                    </div>
                    {isExpanded && (
                        <div className="p-4 border-t border-slate-700/50 bg-black/20 space-y-4 animate-in">
                            
                            {/* --- BARCODE MANAGER --- */}
                            <div className="space-y-2 mb-3">
                                {/* UNIT BARCODE (Siempre visible) */}
                                <div className="flex items-center justify-between bg-slate-900/80 p-3 rounded-lg border border-slate-700/50">
                                    <div className="flex items-center gap-2">
                                        <Icons.Barcode className="text-slate-400" size={16} />
                                        <div className="flex flex-col">
                                            <span className="text-[10px] uppercase text-slate-500 font-bold">Unit Barcode</span>
                                            <span className="text-xs font-mono text-slate-300">{item.barcode || "Sin vincular"}</span>
                                        </div>
                                    </div>
                                    <button onClick={() => onScanRequest(item.id, 'unit')} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs px-3 py-2 rounded-lg font-bold shadow-lg shadow-indigo-900/20 active:scale-95 transition-all">
                                        <Icons.Scan size={14} /> {item.barcode ? "Cambiar" : "Link Unit"}
                                    </button>
                                </div>

                                {/* CASE BARCODE (Solo para Cervezas/Red Bulls/Seltzers) */}
                                {isUnitBased && (
                                    <div className="flex items-center justify-between bg-slate-900/80 p-3 rounded-lg border border-slate-700/50">
                                        <div className="flex items-center gap-2">
                                            <Icons.Box className="text-amber-500" size={16} />
                                            <div className="flex flex-col">
                                                <span className="text-[10px] uppercase text-amber-500/70 font-bold">Case Barcode (24pk)</span>
                                                <span className="text-xs font-mono text-slate-300">{item.barcode_case || "Sin vincular"}</span>
                                            </div>
                                        </div>
                                        <button onClick={() => onScanRequest(item.id, 'case')} className="flex items-center gap-2 bg-amber-700 hover:bg-amber-600 text-white text-xs px-3 py-2 rounded-lg font-bold shadow-lg shadow-amber-900/20 active:scale-95 transition-all">
                                            <Icons.Scan size={14} /> {item.barcode_case ? "Cambiar" : "Link Case"}
                                        </button>
                                    </div>
                                )}
                            </div>
                            {/* --- FIN BARCODE MANAGER --- */}
                            
                            <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                <div className="flex items-center gap-2 mb-3 text-indigo-400 font-bold text-[10px] uppercase tracking-wider"><Icons.Box size={12} /> 1. On Hand (Start)</div>
                                <div className="grid grid-cols-4 gap-2">
                                    <InputField label="Bar 1" value={item.start_bar1} onChange={(v) => onUpdate(item.id, 'start_bar1', v)} colorClass="border-gray-700 focus:border-amber-500" />
                                    <InputField label="Bar 2" value={item.start_bar2} onChange={(v) => onUpdate(item.id, 'start_bar2', v)} colorClass="border-gray-700 focus:border-amber-500" />
                                    <InputField label="Storage" value={item.start_bodega} onChange={(v) => onUpdate(item.id, 'start_bodega', v)} colorClass="border-gray-700 focus:border-amber-500" />
                                    <InputField label="Barroluco" value={item.start_barroluco} onChange={(v) => onUpdate(item.id, 'start_barroluco', v)} colorClass="border-gray-700 focus:border-amber-500" />
                                </div>
                                <div className="text-right mt-2 text-xs font-bold text-amber-500/80">Total: {totalStart}</div>
                            </div>
                            <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                                <div className="grid grid-cols-1 gap-3"><InputField label="2. Purchases (+)" value={item.purchases} onChange={(v) => onUpdate(item.id, 'purchases', v)} icon={Icons.ShoppingCart} colorClass="border-emerald-900/50 focus:border-emerald-500 text-emerald-300" /></div>
                            </div>
                            <div className="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                <div className="flex items-center gap-2 mb-3 text-indigo-400 font-bold text-[10px] uppercase tracking-wider"><Icons.MapPin size={12} /> 3. Physical Count (End)</div>
                                <div className="grid grid-cols-4 gap-2">
                                    <InputField label="Bar 1" value={item.bar1} onChange={(v) => onUpdate(item.id, 'bar1', v)} colorClass="border-gray-700 focus:border-indigo-500" />
                                    <InputField label="Bar 2" value={item.bar2} onChange={(v) => onUpdate(item.id, 'bar2', v)} colorClass="border-gray-700 focus:border-indigo-500" />
                                    <InputField label="Storage" value={item.bodega} onChange={(v) => onUpdate(item.id, 'bodega', v)} colorClass="border-gray-700 focus:border-indigo-500" />
                                    <InputField label="Barroluco" value={item.barroluco} onChange={(v) => onUpdate(item.id, 'barroluco', v)} colorClass="border-gray-700 focus:border-indigo-500" />
                                </div>
                                <div className="text-right mt-2 text-xs font-bold text-indigo-400">Total: {totalPhys}</div>
                            </div>
                            <div className="bg-amber-900/10 p-3 rounded-lg border border-amber-900/20">
                                <div className="flex items-center gap-2 mb-3 text-amber-500 font-bold text-[10px] uppercase tracking-wider"><Icons.Calculator size={12} /> 4. Sales Calculator (POS)</div>
                                <div className="mb-4 bg-amber-500/5 p-3 rounded border border-amber-500/10">
                                    <div className="text-[10px] text-amber-300 mb-1 uppercase font-bold">{isUnitBased ? "Unit Calculator" : `Shot Calculator (1.2oz @ ${isWells ? '1L' : '750ml'})`}</div>
                                    <div className="grid grid-cols-3 gap-3 mb-2">
                                        <div className="relative group"><label className="block text-[10px] text-amber-300/70 font-bold uppercase mb-1">{isUnitBased ? "Cans / Units" : "Bottles"}</label><input type="number" step="1" placeholder="0" value={item.sold_bottles || ""} onChange={(e) => handleSalesChange('bottles', e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 font-mono text-sm focus:outline-none focus:border-amber-500 text-amber-100" /></div>
                                        <div className="relative group"><label className="block text-[10px] text-amber-300/70 font-bold uppercase mb-1">{isUnitBased ? "Buckets (x6)" : "Shots"}</label><input type="number" step="1" placeholder="0" value={item.sold_shots || ""} onChange={(e) => handleSalesChange('shots', e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 font-mono text-sm focus:outline-none focus:border-amber-500 text-amber-100" /></div>
                                        <div className="relative group"><label className="block text-[10px] text-amber-300/70 font-bold uppercase mb-1">{isUnitBased ? "Comps (Units)" : "Comps (Bottles)"}</label><input type="number" step="1" placeholder="0" value={item.sold_comps || ""} onChange={(e) => handleSalesChange('comps', e.target.value)} className="w-full bg-slate-900 border border-emerald-700/50 rounded-lg px-2 py-2 font-mono text-sm focus:outline-none focus:border-emerald-500 text-emerald-100" /></div>
                                    </div>
                                    <div className="text-[9px] text-gray-500 mt-1">{isUnitBased ? "Auto-updates. (1 Bucket = 6 Units) + Comps" : `Auto-updates. (1 Bottle = ${shotsPerBottle.toFixed(2)} Shots) + Comps`}</div>
                                </div>
                                <div className="grid grid-cols-1 gap-3"><InputField label="Total Sales POS (Calculated)" value={item.sales} onChange={(v) => handleDirectSalesUpdate(v)} icon={Icons.DollarSign} colorClass="border-blue-900/50 focus:border-blue-500 text-blue-300" /></div>
                                <div className="text-right mt-4 text-xs text-gray-400 font-mono space-y-2">
                                    <div className="text-amber-500/80">Sys Sales = {totalStart} + {purchases || 0} - {totalPhys} = <b>{systemConsumption}</b></div>
                                    <div className={`text-xl font-black ${diff < 0 ? 'text-red-600' : 'text-emerald-600'}`}>Diff = {diff.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const createItem = (id, name) => ({ id, name, bar1: "", bar2: "", bodega: "", barroluco: "", start_bar1: "", start_bar2: "", start_bodega: "", start_barroluco: "", purchases: "", sales: "", sold_bottles: "", sold_shots: "", sold_comps: "", barcode: "", barcode_case: "" });

        const INITIAL_DATA = [
            { category: "Premium Liquor (Tequila/Whisky)", items: [ createItem("liq-1", "Casamigos Blanco"), createItem("liq-2", "Casamigos Reposado"), createItem("liq-23", "Espolon Blanco"), createItem("liq-24", "Espolon Reposado"), createItem("liq-25", "Patron Cristalino"), createItem("liq-3", "Don Julio Blanco"), createItem("liq-4", "Don Julio Reposado"), createItem("liq-6", "Patron Silver"), createItem("liq-7", "Patron Reposado"), createItem("liq-8", "Clase Azul"), createItem("liq-9", "Grand Old Parr 12"), createItem("liq-11", "Crown Royal Regal"), createItem("liq-10", "Apple Crown Royal"), createItem("liq-26", "Hennessy VS"), createItem("liq-12", "Buchanans 12"), createItem("liq-13", "Johnnie Walker Black"), createItem("liq-14", "Capitan Morgan Spice"), createItem("liq-15", "Brugal Anejo"), createItem("liq-27", "Tito's Texas Vodka"), createItem("liq-16", "Grey Goose"), createItem("liq-17", "Jack Daniels Black"), createItem("liq-18", "WoodFord Reserve"), createItem("liq-19", "Fernet Branca"), createItem("liq-28", "Jagermeister"), createItem("liq-29", "Jameson"), createItem("liq-30", "Beefeater"), createItem("liq-32", "Wahaka Mezcal"), createItem("liq-31", "Malibu"), createItem("vin-4", "Moet Imperial Necta Rose"), createItem("liq-20", "Disaronno Amaretto"), createItem("vin-3", "Procecco Zonin"), createItem("liq-21", "Remy Martin"), createItem("liq-22", "Novo Fogo Silver Cachaca") ]},
            { category: "Wells (House Liquor)", items: [ createItem("wel-1", "Bacardi Light"), createItem("wel-2", "Bacardi Lime"), createItem("wel-13", "Bacardi Limon"), createItem("wel-3", "Pirassununga CachaÃ§a 51"), createItem("wel-4", "Barton Naturals Vodka"), createItem("wel-15", "Barton Gin"), createItem("wel-5", "Peach Schnapps Boston"), createItem("wel-6", "Montezuma White"), createItem("wel-7", "Triple Sec Boston"), createItem("wel-8", "Long Island Tea Mix"), createItem("wel-9", "Curacao Blue"), createItem("wel-10", "Melon Boston"), createItem("wel-14", "Sour Apple"), createItem("wel-11", "Sour Apple HW"), createItem("wel-12", "Sour Cherry Boston") ]},
            { category: "Seltzer & Energy", items: [ createItem("sel-1", "Red Bull Sugar Free"), createItem("sel-2", "Red Bull Regular"), createItem("sel-3", "Red Bull Watermelon"), createItem("sel-4", "Red Bull Juneberry"), createItem("sel-5", "High Noon Variety Pack") ]},
            { category: "Beers", items: [ createItem("cer-1", "Pacifico"), createItem("cer-2", "Michelob Ultra"), createItem("cer-3", "Modelo Especial"), createItem("cer-5", "Corona"), createItem("cer-4", "Heineken") ]},
            { category: "Wines", items: [ createItem("vin-1", "Sangria"), createItem("vin-2", "Chardonnay El Enemigo"), createItem("vin-5", "Cafayate Malbec") ]}
        ];

        function App() {
            const [data, setData] = useState(INITIAL_DATA);
            const [loading, setLoading] = useState(true);
            const [isCloud, setIsCloud] = useState(false);
            const [user, setUser] = useState(null);
            const [logo, setLogo] = useState(localStorage.getItem('BAR_LOGO') || "A New Design (4).jpg");
            const fb = window.fb;
            const fileInputRef = useRef(null);
            const [scanningForItem, setScanningForItem] = useState(null); // { id, type: 'unit'|'case' }
            const LOCAL_STORAGE_KEY = 'bar-inventory-final-v26'; 

            useEffect(() => {
                const initApp = async () => {
                    if (FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.apiKey !== "" && fb) {
                        try {
                            const app = fb.initializeApp(FIREBASE_CONFIG);
                            const auth = fb.getAuth(app);
                            const db = fb.getFirestore(app);
                            try { await fb.signInAnonymously(auth); } catch (authError) { throw new Error("Auth failed"); }
                            fb.onAuthStateChanged(auth, (u) => {
                                setUser(u);
                                if (u) {
                                    setIsCloud(true);
                                    const docRef = fb.doc(db, 'inventory', 'master');
                                    fb.onSnapshot(docRef, (docSnap) => {
                                        if (docSnap.exists()) setData(docSnap.data().items);
                                        else { fb.setDoc(docRef, { items: INITIAL_DATA }); setData(INITIAL_DATA); }
                                        setLoading(false);
                                    }, (err) => { setIsCloud(false); loadLocal(); });
                                }
                            });
                        } catch (e) { setIsCloud(false); loadLocal(); }
                    } else { setIsCloud(false); loadLocal(); }
                };
                const loadLocal = () => {
                    try {
                        const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
                        if (saved) {
                            let loaded = JSON.parse(saved);
                            let updated = false;
                            INITIAL_DATA.forEach(initCat => {
                                let targetCat = loaded.find(c => c.category === initCat.category);
                                if (targetCat) {
                                    initCat.items.forEach(initItem => {
                                        if (!targetCat.items.find(i => i.id === initItem.id)) { targetCat.items.push(initItem); updated = true; }
                                    });
                                } else { loaded.push(initCat); updated = true; }
                            });
                            if (updated) localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(loaded));
                            setData(loaded);
                        } else setData(INITIAL_DATA);
                    } catch(e) {}
                    setLoading(false);
                };
                initApp();
            }, []);

            const downloadReport = () => {
                const dateObj = new Date();
                const safeDate = dateObj.toISOString().split('T')[0];
                const formattedDate = dateObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                let items = []; let totalConsumed = 0; let totalSold = 0; let totalDiff = 0;
                data.forEach(cat => {
                    cat.items.forEach(item => {
                        const totalPhys = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
                        const totalStart = (parseFloat(item.start_bar1)||0) + (parseFloat(item.start_bar2)||0) + (parseFloat(item.start_bodega)||0) + (parseFloat(item.start_barroluco)||0);
                        const purchases = parseFloat(item.purchases)||0;
                        const sales = parseFloat(item.sales)||0;
                        const systemConsumption = totalStart + purchases - totalPhys;
                        const diff = sales - systemConsumption;
                        if (systemConsumption > 0 || sales > 0) {
                            items.push({ ...item, category: cat.category, totalStart, totalPhys, purchases, systemConsumption, sales, diff });
                            totalConsumed += systemConsumption; totalSold += sales; totalDiff += diff;
                        }
                    });
                });
                items.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));
                let csv = `REPORTE EJECUTIVO - PALMAS TROPICAL ESCAPE\nFecha de Corte: ${formattedDate}\n\nRESUMEN GENERAL\nTotal Consumido (Inventario),${totalConsumed.toFixed(2)}\nTotal Vendido (POS),${totalSold.toFixed(2)}\nDiferencia Neta (Net Diff),${totalDiff.toFixed(2)}\n\nDETALLE DE MOVIMIENTOS (Ordenado por Impacto)\nPRODUCTO,CATEGORIA,INICIO,COMPRAS,FINAL FISICO,CONSUMO REAL,VENTAS POS,DIFERENCIA,ESTADO,BOTELLAS VEND,TRAGOS VEND,COMPS\n`;
                items.forEach(item => {
                    let status = "OK"; if (item.diff < -0.1) status = "PERDIDA (LOSS)"; if (item.diff > 0.1) status = "SOBRANTE (GAIN)";
                    csv += `"${item.name}","${item.category}",${item.totalStart},${item.purchases},${item.totalPhys},${item.systemConsumption.toFixed(2)},${item.sales.toFixed(2)},${item.diff.toFixed(2)},${status},${item.sold_bottles || 0},${item.sold_shots || 0},${item.sold_comps || 0}\n`;
                });
                const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a"); link.href = url; link.setAttribute("download", `Analisis_Palmas_${safeDate}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); showNotification("Reporte AnalÃ­tico Descargado!");
            };

            const saveData = (newData) => {
                setData(newData);
                if (isCloud && user) {
                    try {
                        const app = fb.initializeApp(FIREBASE_CONFIG);
                        const db = fb.getFirestore(app);
                        fb.setDoc(fb.doc(db, 'inventory', 'master'), { items: newData });
                    } catch (e) {}
                } else localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(newData));
            };

            const [searchTerm, setSearchTerm] = useState("");
            const [openCategories, setOpenCategories] = useState({ "Premium Liquor (Tequila/Whisky)": true });
            const [notification, setNotification] = useState(null);
            const [modalConfig, setModalConfig] = useState(null);
            const [showCharts, setShowCharts] = useState(false);
            const [showShopping, setShowShopping] = useState(false);
            const [shoppingItems, setShoppingItems] = useState([]);
            const [isScanning, setIsScanning] = useState(false);
            const [pendingBarcode, setPendingBarcode] = useState(null);
            const [quickScanItemId, setQuickScanItemId] = useState(null);

            const handleScanSuccess = (decodedText) => {
                playSound('success'); 
                setIsScanning(false); 
                
                // LÃ“GICA DE VINCULACIÃ“N (LINKING)
                if (scanningForItem) {
                    const { id, type } = scanningForItem;
                    const targetField = type === 'case' ? 'barcode_case' : 'barcode';
                    const label = type === 'case' ? 'Caja (Case)' : 'Unidad';

                    const newData = data.map(cat => ({ 
                        ...cat, 
                        items: cat.items.map(item => item.id === id ? { ...item, [targetField]: decodedText } : item) 
                    }));
                    saveData(newData); 
                    showNotification(`CÃ³digo de ${label} vinculado!`); 
                    setScanningForItem(null); 
                    return;
                }
                
                // LÃ“GICA DE BÃšSQUEDA (SEARCH)
                let foundItem = null;
                for (const cat of data) { 
                    // Busca coincidencias en unidad O en caja
                    const match = cat.items.find(i => i.barcode === decodedText || i.barcode_case === decodedText); 
                    if (match) { foundItem = match; break; } 
                }
                
                if (foundItem) { 
                    setQuickScanItemId(foundItem.id); 
                    showNotification(`Abriendo: ${foundItem.name}`); 
                } else { 
                    alert(`Producto no encontrado.`);
                    setIsScanning(true); // Vuelve a abrir el escÃ¡ner si no se encuentra nada
                }
            };

            // Permite especificar si se escanea para unidad o caja
            const requestItemScan = (itemId, type = 'unit') => { setScanningForItem({ id: itemId, type }); setIsScanning(true); };

            const linkBarcodeToItem = (itemId) => {
                if (!pendingBarcode) return;
                const newData = data.map(cat => ({ ...cat, items: cat.items.map(item => item.id === itemId ? { ...item, barcode: pendingBarcode } : item) }));
                saveData(newData); setPendingBarcode(null); showNotification("Barcode Linked!");
            };

            const generateShoppingList = () => {
                const toBuy = [];
                data.forEach(cat => {
                    cat.items.forEach(item => {
                        const target = PAR_LEVELS[item.name];
                        if (target !== undefined) {
                            const current = (parseFloat(item.bar1)||0) + (parseFloat(item.bar2)||0) + (parseFloat(item.bodega)||0) + (parseFloat(item.barroluco)||0);
                            const needed = target - current;
                            if (needed > 0) {
                                let displayQuantity = needed; let details = null;
                                const isBeer = cat.category.includes("Beers"); const isRedBull = item.name.includes("Red Bull");
                                const customRound = (val) => { const decimal = val - Math.floor(val); const cleanDecimal = parseFloat(decimal.toFixed(2)); return cleanDecimal > 0.5 ? Math.ceil(val) : Math.floor(val); };
                                if (isBeer || isRedBull) { const cases = customRound(needed / 24); displayQuantity = `${cases} Cases`; details = `(${needed} units needed)`; } else { displayQuantity = customRound(needed); }
                                toBuy.push({ name: item.name, current, target, needed: displayQuantity, details });
                            }
                        }
                    });
                });
                setShoppingItems(toBuy); setShowShopping(true);
            };

            const confirmNewPeriod = () => {
                setModalConfig({
                    title: "Start Next Period?", message: "Moves Physical to On Hand.\nClears Sales/Purchases.", isDestructive: false,
                    onConfirm: () => {
                        const newData = data.map(cat => ({
                            ...cat,
                            items: cat.items.map(item => {
                                const physBodega = parseFloat(item.bodega) || 0;
                                return { ...item, start_bar1: item.bar1 !== "" ? item.bar1 : 0, start_bar2: item.bar2 !== "" ? item.bar2 : 0, start_bodega: physBodega, start_barroluco: item.barroluco !== "" ? item.barroluco : 0, bar1: "", bar2: "", bodega: "", barroluco: "", purchases: "", sales: "", sold_bottles: "", sold_shots: "", sold_comps: "" };
                            })
                        }));
                        saveData(newData); setModalConfig(null); showNotification("New Period Started!");
                    }
                });
            };

            const confirmClearAll = () => { setModalConfig({ title: "Reset All?", message: "WARNING: Deletes ALL data to ZERO.", isDestructive: true, onConfirm: () => { saveData(INITIAL_DATA); setModalConfig(null); showNotification("Reset Complete."); } }); };
            const handleBackup = () => { const blob = new Blob([JSON.stringify(data)], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `Bar_Backup_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleRestoreFile = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if (Array.isArray(d) && d[0].category) { saveData(d); showNotification("Restored!"); } else alert("Invalid file."); } catch(err) { alert("Error reading file."); } }; reader.readAsText(file); e.target.value = null; };
            const handleLogoChange = (e) => { const file = e.target.files[0]; if (!file) return; if (file.size > 2 * 1024 * 1024) { alert("Image too large. Please use an image under 2MB."); return; } const reader = new FileReader(); reader.onload = (ev) => { const base64 = ev.target.result; setLogo(base64); localStorage.setItem('BAR_LOGO', base64); showNotification("Logo Updated!"); }; reader.readAsDataURL(file); };
            const updateItem = (itemId, fieldOrObj, value) => { const newData = data.map(cat => ({ ...cat, items: cat.items.map(item => { if (item.id === itemId) { if (typeof fieldOrObj === 'object' && fieldOrObj !== null) return { ...item, ...fieldOrObj }; return { ...item, [fieldOrObj]: value }; } return item; }) })); saveData(newData); };
            const showNotification = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };
            
            const filteredData = useMemo(() => {
                if (!searchTerm) return data;
                const normalize = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const term = normalize(searchTerm);
                const tightTerm = term.replace(/\s+/g, '');
                return data.map(cat => ({ ...cat, items: cat.items.filter(item => { const nameMatch = normalize(item.name).includes(term); const catMatch = normalize(cat.category).includes(term); const tightName = normalize(item.name).replace(/\s+/g, ''); const tightMatch = tightName.includes(tightTerm); return nameMatch || catMatch || tightMatch; }) })).filter(cat => cat.items.length > 0);
            }, [data, searchTerm]);

            const getIcon = (n) => { if (n.includes("Premium")) return Icons.GlassWater; if (n.includes("Wells")) return Icons.Package; if (n.includes("Beers")) return Icons.Beer; if (n.includes("Wines")) return Icons.Wine; return Icons.RefreshCw; };
            const activeQuickItem = useMemo(() => { if (!quickScanItemId) return null; for (const cat of data) { const found = cat.items.find(i => i.id === quickScanItemId); if (found) return found; } return null; }, [data, quickScanItemId]);

            if (loading) return <div className="flex items-center justify-center min-h-screen text-slate-500">Loading...</div>;

            return (
                <div className="min-h-screen bg-slate-900 font-sans pb-20">
                    <div className="fixed top-0 left-0 right-0 z-50 shadow-xl bg-slate-900">
                        <Header onNewPeriod={confirmNewPeriod} onClearAll={confirmClearAll} onDownload={downloadReport} onShowCharts={() => setShowCharts(true)} onBackup={handleBackup} onRestore={() => fileInputRef.current.click()} isCloud={isCloud} onScan={() => setIsScanning(true)} onShopping={generateShoppingList} logoSrc={logo} onLogoUpload={handleLogoChange} />
                        <div className="bg-slate-950 p-4 border-b border-slate-800">
                            <div className="max-w-5xl mx-auto relative"><Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={20} /><input type="text" placeholder="Search product..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-slate-900 rounded-xl pl-10 pr-4 py-3 text-slate-200 border border-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all placeholder:text-slate-600" /></div>
                        </div>
                        {pendingBarcode && <div className="bg-indigo-900 p-2 text-center text-white border-b border-indigo-700"><p className="font-bold text-sm">Barcode: {pendingBarcode}</p><p className="text-[10px] text-indigo-200">Find item below and click "Link"</p><button onClick={() => setPendingBarcode(null)} className="mt-1 text-[10px] underline hover:text-indigo-300">Cancel</button></div>}
                    </div>
                    <input type="file" ref={fileInputRef} style={{display:'none'}} accept=".json" onChange={handleRestoreFile} />
                    <div className="pt-[320px] lg:pt-[230px]"></div>
                    <main className="max-w-5xl mx-auto p-4 space-y-4">
                        {filteredData.length === 0 && <div className="text-center py-20 text-slate-500"><p>No products found.</p></div>}
                        {filteredData.map((cat) => (
                            <div key={cat.category} className="mb-6">
                                {!searchTerm && <CategoryHeader title={cat.category} icon={getIcon(cat.category)} isOpen={openCategories[cat.category]} toggle={() => setOpenCategories(prev => ({...prev, [cat.category]: !prev[cat.category]}))} />}
                                {(openCategories[cat.category] || searchTerm) && (
                                    <div className="grid gap-2 sm:grid-cols-1 lg:grid-cols-2">
                                        {cat.items.map(item => (<InventoryRow key={item.id} item={item} onUpdate={updateItem} onLinkBarcode={linkBarcodeToItem} pendingBarcode={pendingBarcode} isWells={cat.category.includes("Wells")} categoryName={cat.category} onScanRequest={requestItemScan} />))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </main>
                    <ConfirmationModal isOpen={!!modalConfig} onClose={() => setModalConfig(null)} onConfirm={modalConfig?.onConfirm} title={modalConfig?.title} message={modalConfig?.message} isDestructive={modalConfig?.isDestructive} />
                    {showCharts && <ChartsView data={data} onClose={() => setShowCharts(false)} />}
                    {showShopping && <ShoppingListModal isOpen={showShopping} onClose={() => setShowShopping(false)} items={shoppingItems} />}
                    {isScanning && <ScannerModal onScanSuccess={handleScanSuccess} onClose={() => { setIsScanning(false); setScanningForItem(null); }} />}
                    
                    {/* Reabre el escÃ¡ner automÃ¡ticamente despuÃ©s de QuickEdit */}
                    {quickScanItemId && activeQuickItem && (
                        <QuickEditModal 
                            item={activeQuickItem} 
                            onClose={() => { 
                                setQuickScanItemId(null); 
                                setIsScanning(true);
                            }} 
                            onUpdate={updateItem} 
                        />
                    )}
                    
                    {/* Mensaje de vinculaciÃ³n (diferenciado por tipo) */}
                    {isScanning && scanningForItem && (
                        <div className="fixed top-16 left-0 right-0 z-[60] text-center pointer-events-none">
                            <span className={`px-4 py-1 rounded-full text-sm font-bold shadow-lg border ${scanningForItem.type === 'case' ? 'bg-amber-600 border-amber-400' : 'bg-indigo-600 border-indigo-400'} text-white`}>
                                {scanningForItem.type === 'case' ? 'Vinculando CAJA (24pk)...' : 'Vinculando UNIDAD...'}
                            </span>
                        </div>
                    )}

                    {notification && <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-700 flex items-center gap-3 animate-in z-50 whitespace-nowrap"><Icons.CheckCircle size={18} className="text-emerald-400" /><span className="font-medium text-sm">{notification}</span></div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>